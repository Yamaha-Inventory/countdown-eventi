<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Countdown Eventi</title>
<style>
  html, body {
    height: 100%;
    margin: 0;
    font-family: Arial, sans-serif;
    background-image: url('monster.jpg'); /* immagine sfondo */
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    color: black;
  }
  #header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    background: transparent;
  }
  #fileInput {
    font-size: 16px;
  }
  #orario {
    font-size: 28px;
    font-weight: bold;
    background: transparent;
    user-select: none;
  }
  #eventi_riepilogo {
    position: fixed;
    top: 60px;
    left: 20px;
    width: 320px;
    max-height: 80vh;
    overflow-y: auto;
    font-size: 18px;
    line-height: 1.4em;
    background: transparent;
    user-select: none;
    color: black;
  }
  .evento_passato {
    text-decoration: line-through;
    color: gray;
  }
  #countdown_centrale {
    position: fixed;
    top: 38%;  /* spostato leggermente su */
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 56px;
    font-weight: bold;
    text-align: center;
    white-space: pre-line;
    user-select: none;
    color: black;
    background: transparent;
  }
</style>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>

<div id="header">
  <input type="file" id="fileInput" accept=".xlsx" />
  <div id="orario">--:--:--</div>
</div>

<div id="eventi_riepilogo">Carica un file Excel per vedere gli eventi.</div>
<div id="countdown_centrale"></div>

<script>
  let eventi = [];
  let prossimoEventoIndex = null;

  const orarioEl = document.getElementById('orario');
  const eventiRiepilogoEl = document.getElementById('eventi_riepilogo');
  const countdownCentraleEl = document.getElementById('countdown_centrale');
  const fileInput = document.getElementById('fileInput');
  let timerId = null;

  // Funzione per convertire numero seriale Excel in "HH:MM"
  function excelTimeToHHMM(excelTime) {
    let totalSeconds = Math.round(excelTime * 24 * 3600);
    let hours = Math.floor(totalSeconds / 3600);
    let minutes = Math.floor((totalSeconds % 3600) / 60);
    if (hours < 10) hours = "0" + hours;
    if (minutes < 10) minutes = "0" + minutes;
    return `${hours}:${minutes}`;
  }

  fileInput.addEventListener('change', function(evt){
    const file = evt.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const firstSheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[firstSheetName];
      const json = XLSX.utils.sheet_to_json(worksheet, {header:["Ora","Evento"], defval:""});

      // Rimuove header se presente
      if (json.length > 0 && (String(json[0].Ora).toLowerCase() === "ora" || String(json[0].Evento).toLowerCase() === "evento")) {
        json.shift();
      }

      eventi = json.map(row => {
        let oraRaw = row.Ora;
        let oraStr = "";

        if (typeof oraRaw === "number") {
          // Excel serial time -> stringa hh:mm
          oraStr = excelTimeToHHMM(oraRaw);
        } else {
          oraStr = String(oraRaw).trim();
        }

        return {
          ora: oraStr,
          evento: String(row.Evento).trim()
        };
      }).filter(e => e.ora && e.evento);

      // Calcola minuti da ora
      eventi.forEach(ev => {
        const parts = ev.ora.split(":");
        if(parts.length === 2){
          const h = parseInt(parts[0]);
          const m = parseInt(parts[1]);
          ev.minuti = h * 60 + m;
        } else {
          ev.minuti = 0; // fallback
        }
      });

      eventi.sort((a,b) => a.minuti - b.minuti);
      prossimoEventoIndex = null;

      aggiornaVisualizzazione();
      startTimer();
    }
    reader.readAsArrayBuffer(file);
  });

  function aggiornaOrario() {
    const now = new Date();
    orarioEl.textContent = now.toLocaleTimeString();
  }

  function aggiornaVisualizzazione() {
    const now = new Date();
    const minutiAdesso = now.getHours()*60 + now.getMinutes();

    prossimoEventoIndex = null;

    eventiRiepilogoEl.innerHTML = eventi.map((ev, i) => {
      const passato = ev.minuti < minutiAdesso;
      if (!passato && prossimoEventoIndex === null) prossimoEventoIndex = i;
      const classe = passato ? "evento_passato" : "";
      return `<div class="${classe}">${ev.ora} - ${ev.evento.toUpperCase()}</div>`;
    }).join("");

    if (prossimoEventoIndex !== null && prossimoEventoIndex < eventi.length) {
      const ev = eventi[prossimoEventoIndex];
      const nowSec = now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds();
      const evSec = ev.minuti*60;
      let diffSec = evSec - nowSec;
      if (diffSec < 0) diffSec = 0;

      const minuti = Math.floor(diffSec / 60);
      const secondi = diffSec % 60;

      countdownCentraleEl.textContent = `MANCANO ${minuti} MINUTI E ${secondi} SECONDI ALL'INIZIO DI:\n\n${ev.evento.toUpperCase()}`;
    } else {
      countdownCentraleEl.textContent = "NESSUN EVENTO IN PROGRAMMA";
    }
  }

  function startTimer(){
    if(timerId) clearInterval(timerId);
    aggiornaOrario();
    aggiornaVisualizzazione();
    timerId = setInterval(() => {
      aggiornaOrario();
      aggiornaVisualizzazione();
    }, 1000);
  }
</script>

</body>
</html>
