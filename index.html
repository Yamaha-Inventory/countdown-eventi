<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Event Countdown</title>
<style>
  html, body {
    height: 100%;
    margin: 0;
    font-family: Arial, sans-serif;
    background-image: url('monster.jpg'); /* Background image */
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    color: black;
  }
  #header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    background: transparent;
  }
  #fileInput {
    font-size: 16px;
  }
  #currentTime {
    font-size: 28px;
    font-weight: bold;
    background: transparent;
    user-select: none;
  }
  #eventSummary {
    position: fixed;
    top: 60px;
    left: 20px;
    width: 320px;
    max-height: 80vh;
    overflow-y: auto;
    font-size: 18px;
    line-height: 1.4em;
    background: transparent;
    user-select: none;
    color: black;
  }
  .pastEvent {
    text-decoration: line-through;
    color: gray;
  }
  #centralCountdown {
    position: fixed;
    top: 38%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 56px;
    font-weight: bold;
    text-align: center;
    white-space: pre-line;
    user-select: none;
    color: black;
    background: transparent;
  }
</style>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>

<div id="header">
  <input type="file" id="fileInput" accept=".xlsx" />
  <div id="currentTime">--:--:--</div>
</div>

<div id="eventSummary">Upload an Excel file to view the events.</div>
<div id="centralCountdown"></div>

<script>
  let events = [];
  let nextEventIndex = null;

  const timeDisplay = document.getElementById('currentTime');
  const summaryDisplay = document.getElementById('eventSummary');
  const countdownDisplay = document.getElementById('centralCountdown');
  const fileInput = document.getElementById('fileInput');
  let timerId = null;

  function excelTimeToHHMM(excelTime) {
    let totalSeconds = Math.round(excelTime * 24 * 3600);
    let hours = Math.floor(totalSeconds / 3600);
    let minutes = Math.floor((totalSeconds % 3600) / 60);
    if (hours < 10) hours = "0" + hours;
    if (minutes < 10) minutes = "0" + minutes;
    return `${hours}:${minutes}`;
  }

  fileInput.addEventListener('change', function(evt){
    const file = evt.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const firstSheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[firstSheetName];
      const json = XLSX.utils.sheet_to_json(worksheet, {header:["Time","Event"], defval:""});

      // Check and keep the header separately
      let headerText = "";
      if (json.length > 0 && (
          String(json[0].Time).toLowerCase() === "time" ||
          String(json[0].Time).toLowerCase() === "orario"
      )) {
        headerText = `${json[0].Time} - ${json[0].Event}`;
        json.shift();
      }

      events = json.map(row => {
        let rawTime = row.Time;
        let timeStr = "";

        if (typeof rawTime === "number") {
          timeStr = excelTimeToHHMM(rawTime);
        } else {
          timeStr = String(rawTime).trim();
        }

        return {
          time: timeStr,
          event: String(row.Event).trim()
        };
      }).filter(e => e.time && e.event);

      events.forEach(ev => {
        const parts = ev.time.split(":");
        if(parts.length === 2){
          const h = parseInt(parts[0]);
          const m = parseInt(parts[1]);
          ev.minutes = h * 60 + m;
        } else {
          ev.minutes = 0;
        }
      });

      events.sort((a,b) => a.minutes - b.minutes);
      nextEventIndex = null;

      updateDisplay(headerText);
      startTimer(headerText);
    }
    reader.readAsArrayBuffer(file);
  });

  function updateClock() {
    const now = new Date();
    timeDisplay.textContent = now.toLocaleTimeString();
  }

  function updateDisplay(headerText = "") {
    const now = new Date();
    const currentMinutes = now.getHours()*60 + now.getMinutes();
    nextEventIndex = null;

    let summaryHTML = "";

    if (headerText) {
      summaryHTML += `<div style="font-weight: bold; text-decoration: none; color: black; margin-bottom: 10px;">${headerText}</div>`;
    }

    summaryHTML += events.map((ev, i) => {
      const isPast = ev.minutes < currentMinutes;
      if (!isPast && nextEventIndex === null) nextEventIndex = i;
      const className = isPast ? "pastEvent" : "";
      return `<div class="${className}">${ev.time} - ${ev.event.toUpperCase()}</div>`;
    }).join("");

    summaryDisplay.innerHTML = summaryHTML;

    // Update central countdown
    if (nextEventIndex !== null && nextEventIndex < events.length) {
      const ev = events[nextEventIndex];
      const nowSec = now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds();
      const evSec = ev.minutes*60;
      let diffSec = evSec - nowSec;
      if (diffSec < 0) diffSec = 0;

      const mins = Math.floor(diffSec / 60);
      const secs = diffSec % 60;

      countdownDisplay.textContent = `STARTING IN ${mins} MINUTES AND ${secs} SECONDS:\n\n${ev.event.toUpperCase()}`;
    } else {
      countdownDisplay.textContent = "NO UPCOMING EVENTS";
    }
  }

  function startTimer(headerText){
    if(timerId) clearInterval(timerId);
    updateClock();
    updateDisplay(headerText);
    timerId = setInterval(() => {
      updateClock();
      updateDisplay(headerTe
