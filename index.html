<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Countdown Eventi</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-image: url('https://yamahamotogp.s3-eu-west-1.amazonaws.com/31-01-2025-monster-energy-yamaha-motogp-riders/quartararo-rins/media/MEYMm_01_2025%20Quartararo-Rins.jpg?AWSAccessKeyId=AKIAJJ6WQFZ2IJINZCTA&Expires=1755795400&Signature=U%2FiMJPNT5VGE1Pn8yp3XnCnsJE4%3D');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      color: black;
    }

    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: rgba(255, 255, 255, 0.0);
    }

    #fileInput {
      font-size: 16px;
    }

    #orario {
      font-size: 32px;
      font-weight: bold;
    }

    #eventi_riepilogo {
      position: absolute;
      top: 90px;
      left: 20px;
      width: 300px;
      font-size: 18px;
      line-height: 1.5em;
      background: none;
    }

    .evento_passato {
      text-decoration: line-through;
      color: gray;
    }

    #countdown_centrale {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 48px;
      font-weight: bold;
      text-align: center;
      white-space: pre-line;
      user-select: none;
      background: none;
    }
  </style>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>

  <div id="header">
    <input type="file" id="fileInput" accept=".xlsx" />
    <div id="orario">--:--:--</div>
  </div>

  <div id="eventi_riepilogo"></div>
  <div id="countdown_centrale">CARICA UN FILE EXCEL PER INIZIARE</div>

  <script>
    let eventi = [];
    let prossimoEventoIndex = null;

    const orarioEl = document.getElementById('orario');
    const eventiRiepilogoEl = document.getElementById('eventi_riepilogo');
    const countdownCentraleEl = document.getElementById('countdown_centrale');
    const fileInput = document.getElementById('fileInput');

    fileInput.addEventListener('change', function(evt) {
      const file = evt.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const json = XLSX.utils.sheet_to_json(worksheet, {
          header: ["Ora", "Evento"],
          defval: ""
        });

        if (json.length > 0 && (
            String(json[0].Ora).toLowerCase().includes("ora") ||
            String(json[0].Evento).toLowerCase().includes("evento"))) {
          json.shift();
        }

        eventi = json.map(row => {
          const oraStr = String(row.Ora).trim();
          const eventoStr = String(row.Evento).trim();
          const [h, m] = oraStr.split(":").map(Number);
          return {
            ora: oraStr,
            evento: eventoStr,
            minuti: h * 60 + m
          };
        }).filter(e => !isNaN(e.minuti) && e.evento);

        eventi.sort((a, b) => a.minuti - b.minuti);
        aggiornaVisualizzazione();
        startTimer();
      };
      reader.readAsArrayBuffer(file);
    });

    function aggiornaOrario() {
      const now = new Date();
      orarioEl.textContent = now.toLocaleTimeString();
    }

    function aggiornaVisualizzazione() {
      const now = new Date();
      const minutiAdesso = now.getHours() * 60 + now.getMinutes();

      prossimoEventoIndex = null;

      eventiRiepilogoEl.innerHTML = eventi.map((ev, i) => {
        const passato = ev.minuti < minutiAdesso;
        if (!passato && prossimoEventoIndex === null) prossimoEventoIndex = i;
        const classe = passato ? "evento_passato" : "";
        return `<div class="${classe}">${ev.ora} - ${ev.evento.toUpperCase()}</div>`;
      }).join("");

      if (prossimoEventoIndex !== null && prossimoEventoIndex < eventi.length) {
        const ev = eventi[prossimoEventoIndex];
        const nowSec = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
        const evSec = ev.minuti * 60;
        let diffSec = evSec - nowSec;
        if (diffSec < 0) diffSec = 0;

        const minuti = Math.floor(diffSec / 60);
        const secondi = diffSec % 60;

        countdownCentraleEl.textContent = `MANCANO ${minuti} MINUTI E ${secondi} SECONDI ALL'INIZIO DI:\n\n${ev.evento.toUpperCase()}`;
      } else {
        countdownCentraleEl.textContent = "NESSUN EVENTO IN PROGRAMMA";
      }
    }

    let timerId = null;
    function startTimer() {
      if (timerId) clearInterval(timerId);
      aggiornaOrario();
      aggiornaVisualizzazione();
      timerId = setInterval(() => {
        aggiornaOrario();
        aggiornaVisualizzazione();
      }, 1000);
    }
  </script>

</body>
</html>
