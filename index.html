<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Events Countdown</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: white url('https://yamahamotogp.s3-eu-west-1.amazonaws.com/31-01-2025-monster-energy-yamaha-motogp-riders/quartararo-rins/media/MEYMm_01_2025%20Quartararo-Rins.jpg?AWSAccessKeyId=AKIAJJ6WQFZ2IJINZCTA&Expires=1755795400&Signature=U%2FiMJPNT5VGE1Pn8yp3XnCnsJE4%3D') no-repeat center center fixed;
    background-size: cover;
    color: black;
  }
  #header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  #fileInput {
    font-size: 16px;
  }
  #currentTime {
    font-size: 28px;
    font-weight: bold;
  }
  #eventsSummary {
    margin-bottom: 40px;
    width: 320px;
    font-size: 18px;
    line-height: 1.4em;
  }
  .event-passed {
    text-decoration: line-through;
    color: gray;
  }
  #centralCountdown {
    font-size: 52px;
    font-weight: bold;
    text-align: center;
    white-space: pre-line;
    user-select: none;
    margin-top: 60px;
  }
</style>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>

<div id="header">
  <input type="file" id="fileInput" accept=".xlsx" />
  <div id="currentTime">--:--:--</div>
</div>

<div id="eventsSummary">Load an Excel file to begin</div>
<div id="centralCountdown"></div>

<script>
  let events = [];
  let nextEventIndex = null;
  let timerId = null;

  const currentTimeEl = document.getElementById('currentTime');
  const eventsSummaryEl = document.getElementById('eventsSummary');
  const centralCountdownEl = document.getElementById('centralCountdown');
  const fileInput = document.getElementById('fileInput');

  fileInput.addEventListener('change', function(evt) {
    const file = evt.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const firstSheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[firstSheetName];
      const json = XLSX.utils.sheet_to_json(worksheet, {header:["Time","Event"], defval:""});

      // Remove header row if present
      if (json.length > 0 && (String(json[0].Time).toLowerCase() === "time" || String(json[0].Event).toLowerCase() === "event")) {
        json.shift();
      }

      events = json.map(row => ({
        timeStr: String(row.Time).trim(),
        eventName: String(row.Event).trim()
      })).filter(e => e.timeStr && e.eventName);

      // Convert time to minutes from midnight for sorting and comparison
      events.forEach(ev => {
        const [h, m] = ev.timeStr.split(":").map(x => parseInt(x));
        ev.minutesFromMidnight = h * 60 + m;
      });

      // Sort events by ascending time
      events.sort((a,b) => a.minutesFromMidnight - b.minutesFromMidnight);

      nextEventIndex = null;
      updateDisplay();
      startTimer();
    };
    reader.readAsArrayBuffer(file);
  });

  function updateCurrentTime() {
    const now = new Date();
    currentTimeEl.textContent = now.toLocaleTimeString();
  }

  function updateDisplay() {
    const now = new Date();
    const nowMinutes = now.getHours() * 60 + now.getMinutes();

    nextEventIndex = null;

    // Build summary with crossed out events and times
    eventsSummaryEl.innerHTML = events.map((ev, i) => {
      const passed = ev.minutesFromMidnight < nowMinutes;
      if (!passed && nextEventIndex === null) nextEventIndex = i;
      const className = passed ? "event-passed" : "";
      return `<div class="${className}">${ev.timeStr} - ${ev.eventName.toUpperCase()}</div>`;
    }).join("");

    // Central countdown
    if (nextEventIndex !== null && nextEventIndex < events.length) {
      const ev = events[nextEventIndex];
      const nowSeconds = now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds();
      const evSeconds = ev.minutesFromMidnight*60;
      let diffSeconds = evSeconds - nowSeconds;
      if (diffSeconds < 0) diffSeconds = 0;

      const minutes = Math.floor(diffSeconds / 60);
      const seconds = diffSeconds % 60;

      centralCountdownEl.textContent =
        `MISSING ${minutes} MINUTES AND ${seconds} SECONDS\nTO START OF:\n\n${ev.eventName.toUpperCase()}`;
    } else {
      centralCountdownEl.textContent = "NO UPCOMING EVENTS";
    }
  }

  function startTimer() {
    if(timerId) clearInterval(timerId);
    updateCurrentTime();
    updateDisplay();
    timerId = setInterval(() => {
      updateCurrentTime();
      updateDisplay();
    }, 1000);
  }
</script>

</body>
</html>
